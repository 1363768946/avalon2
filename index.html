<!DOCTYPE html>
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="avalon.js"></script>

    </head>
    <body >


        <script>

//不能出现正则，不能出现注释

            var input = "yxxk[aaa], xxx.**, dd,111,'21f'"
            //var input = "xxx.a,dd"
            //能出yxxk[aaa], 得到 一个对象
            //{ words:["yxxk", "aaa","xxx","a","dd"], groups:["yxxk.aaa", "xxx.a"]}
            //words里面为变量,单词
            var i = 0
            var word = ""
            var words = []
            var variables = []
            var endString = ""
            var group = ""
            var groups = []
            var rbracket = /\[(['"]?)([^'"]+)\1\]/
            var addGroup = false

            var isSkip = false
            var append = function () {
                word += cw
                group += cw
            }
            var isIdentifierStart = function (ch) {
                return (ch === 36) || (ch === 95) || // `$` and `_`
                        (ch >= 65 && ch <= 90) || // A...Z
                        (ch >= 97 && ch <= 122); // a...z
            }
            var state = "unknown"
            var states = {
                "unknown": function () {
                    if (isIdentifierStart(ch)) {
                        state = "word"
                        append()

                    } else if (ch === 34 || ch === 39) {
                        state = "string"
                        endString = ch
                    }
                },
                "word": function () {
                    if (/\B/.test(cw)) {//如果遇到~!#^&*(){}[]<>/空白
                        state = "unknown"
                        if (word !== "") {
                            addGroup = true
                            words.push(word)
                            word = ""
                        }
                        if (ch === 46) {//如果遇到 .
                            state = "dot"
                            group += "."
                            addGroup = false
                        } else if (ch === 91) {//如果遇到[
                            group += "."
                            addGroup = false
                            input = input.slice(0, i) +
                                    input.slice(i).replace(rbracket, function ($1, $2, $3) {
                                return  "." + $3.trim()
                            })

                        }
                        if (addGroup) {
                            addGroup = false
                            groups.push(group)
                            group = ""
                        }
                    } else {
                        append()
                    }
                },
                "dot": function () {
                    state = "unknown"
                    //如果是0-9, *, 或是标识符
                    if (ch >= 48 && ch <= 57 || ch === 42 || isIdentifierStart(ch)) {//0-9 
                        state = "word"
                        append()
                    }
                },
                "string": function () {
                    if (isSkip) {
                        isSkip = false //跳过当前字符的检测
                    } else {
                        if (ch === 92) {//如果遇到\\
                            isSkip = true
                        }
                        if (ch === endString) {//如果遇到 " '
                            state = "unknown"
                        }
                    }
                }
            };
            do {
                var ch = input.charCodeAt(i)
                if (ch !== ch) { //void 0 --> NaN
                    if (word !== "") {//收集最后一个单词
                        words.push(word)
                        word = ""
                    }
                    break
                }
                var cw = input.charAt(i)
                states[state]()
                i++
            } while (true);

            console.log(words)
            console.log(groups)
        </script>


    </body>

</html>